// *****************************************************************************************
// 
// templates/operations.*.hbs
//
// *****************************************************************************************
{{#each model.encodes.endPoints}}
  {{#each operations}}

public class {{getValueCSharp name}}Options
{
    {{!-- PATH parameters --}}
    {{#each ../parameters }}
    {{#if @first}}// PATH parameters{{/if}}
    {{!-- {{#if (getValue description)}}{{{getValue description}}}{{/if}} --}}
    public required string {{{getValueCSharp name}}} { get; set; }
    {{/each}}
    {{!-- QUERY parameters --}}
    {{#each request.queryParameters}}
    {{#if @first}}

    // QUERY parameters
    {{/if}}
    public {{#if (is required "true")}}required string{{else}}string?{{/if}} {{{getValueCSharp name}}} { get; set; }
    {{#if @last}}
    public Dictionary<string, string>? Custom { get; set; }
    {{/if}}
    {{/each}}
    {{!-- HEADER parameters --}}
    
    // HEADER parameters
    public required AuthenticationHeaderValue Authorization { get; set; }
    {{#each request.headers}}
    {{#unless (eq (getValue name) "Authorization")}}
    public string? {{{name}}} { get; set; }
    {{/unless}}
    {{/each}}
    {{!-- BODY parameter --}}
    {{#or (is method "patch") (is method "post") (is method "put")}}

    // BODY parameter
    public required {{getPayloadTypeFromRequest request}} Body { get; set; }
    {{/or}}
}

/// <summary>
{{{formatForCSharpXmlDoc description}}}
/// </summary>
{{#if (equalsCSharp (getReturnTypeFromOperationCSharp this) 'void')}}
public async Task<HttpResponseMessage> {{name}}({{getValueCSharp name}}Options options)
{{else}}
public async Task<({{getReturnTypeFromOperationCSharp this}} typedResponse, HttpResponseMessage rawResponse)> {{name}}({{getValueCSharp name}}Options options)
{{/if}}
{
    var request = new HttpRequestMessage();
    request.Method = HttpMethod.{{getValueCSharp method}};

    {{!-- (1) PATH parameters --}}
    //
    // URI PATH parameters
    //
    var uriBuilder = new UriBuilder(BASE_URI);
    var pathTemplate = "{{../path}}";
{{#each ../parameters }}
    {{#if @first}}
    var pathReplacements = new Dictionary<string, string>
    {
    {{/if}}
        { "{{{name}}}", options.{{{getValueCSharp name}}} }{{#unless @last}},{{/unless}}
    {{#if @last}}
    };
    {{/if}}
{{/each}}
    string operationPath = Regex.Replace(pathTemplate, "{(.*?)}", m => pathReplacements[m.Groups[1].Value]);
    uriBuilder.Path = uriBuilder.Path.TrimEnd('/') + '/' + operationPath;
    {{!-- (2) QUERY parameters --}}
{{#each request.queryParameters}}
    {{#if @first}}

    //
    // URI QUERY parameters
    //
    var query = HttpUtility.ParseQueryString(uriBuilder.Query);
    {{/if}}
    query["{{{name}}}"] = options.{{{getValueCSharp name}}};
    {{#if @last}}
    if (options.Custom != null)
    {
        foreach (var pair in options.Custom)
        {
            query[pair.Key] = pair.Value;
        }
    }
    uriBuilder.Query = query.ToString();
    {{/if}}
{{/each}}
    request.RequestUri = uriBuilder.Uri;

    {{!-- (3) HEADER parameters --}}
    //
    // HEADER parameters
    //
    request.Headers.Authorization = options.Authorization;
{{#each request.headers}}
    {{#if (eq (getValue name) "_sfdc_client_auth")}}
    request.Headers.Add("{{{name}}}", options.{{{name}}});
    {{else}}
    {{#unless (eq (getValue name) "Authorization")}}
    request.Headers.{{{name}}} = options.{{{name}}};
    {{/unless}}
    {{/if}}
{{/each}}
    {{!-- (4) BODY parameter --}}
{{#or (is method "patch") (is method "post") (is method "put")}}

    //
    // BODY parameter
    //
    {{!-- *      MEDIA TYPE {{getMediaTypeFromRequest request}} --}}
    {{#if (eq (getMediaTypeFromRequest request) "application/json")}}
    request.Content = new StringContent(JsonSerializer.Serialize(options.Body), Encoding.UTF8, MediaTypeNames.Application.Json);
    {{else if (eq (getMediaTypeFromRequest request)  "application/x-www-form-urlencoded")}}
    var keyValues = new List<KeyValuePair<string, string>>();
    foreach (var prop in typeof({{getPayloadTypeFromRequest request}}).GetProperties())
    {
        var propValue = prop.GetValue(options.Body, null)?.ToString() ?? string.Empty;
        if (!string.IsNullOrEmpty(propValue))
        {
            keyValues.Add(new KeyValuePair<string, string>(ConvertPascalToSnakeCase(prop.Name), propValue));
        }
    }
    request.Content = new FormUrlEncodedContent(keyValues);
    {{else}}
    throw new Exception("Unsupported media type: {{getMediaTypeFromRequest request}}");
    {{/if}}
{{/or}}

    //
    // Call the API
    //
    using (var client = new HttpClient())
    {
        var rawResponse = await client.SendAsync(request);

        if (rawResponse.IsSuccessStatusCode)
        {
{{#if (equalsCSharp (getReturnTypeFromOperationCSharp this) 'void')}}
            return rawResponse;
{{else}}
            string content = await rawResponse.Content.ReadAsStringAsync();
            var jsonSerializerOptions = new JsonSerializerOptions { DefaultIgnoreCondition = JsonIgnoreCondition.WhenWritingNull };
            {{getReturnTypeFromOperationCSharp this}} typedResponse = JsonSerializer.Deserialize<{{getReturnTypeFromOperationCSharp this}}>(content, jsonSerializerOptions)!;
            return (typedResponse, rawResponse);
{{/if}}
        }
        else
        {
            var errorContent = await rawResponse.Content.ReadAsStringAsync();
            throw new HttpRequestException($"Request failed with status code {rawResponse.StatusCode}: {errorContent}");
        }
    }
}
  {{/each}}
{{/each}}